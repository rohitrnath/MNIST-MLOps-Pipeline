<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MNIST Draw & Predict</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    #board { border: 1px solid #ccc; touch-action: none; background: #fff; }
    .controls { margin-top: 10px; display: flex; gap: 10px; align-items: center; }
    .result { margin-top: 12px; font-size: 18px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Draw a digit (0-9) and click Predict</h2>
  <canvas id="board" width="280" height="280"></canvas>
  <div class="controls">
    <button id="clearBtn">Clear</button>
    <button id="predictBtn">Predict</button>
    <span id="status"></span>
  </div>
  <div class="result">Prediction: <span id="pred">-</span></div>

  <script>
    const board = document.getElementById('board');
    const ctx = board.getContext('2d');
    const clearBtn = document.getElementById('clearBtn');
    const predictBtn = document.getElementById('predictBtn');
    const statusEl = document.getElementById('status');
    const predEl = document.getElementById('pred');

    // Drawing setup
    let drawing = false;
    ctx.lineWidth = 20;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000000';

    const getPos = (e) => {
      const rect = board.getBoundingClientRect();
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      return { x, y };
    };

    const start = (e) => { drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
    const move = (e) => { if (!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
    const end = () => { drawing = false; };

    board.addEventListener('mousedown', start);
    board.addEventListener('mousemove', move);
    board.addEventListener('mouseup', end);
    board.addEventListener('mouseleave', end);

    board.addEventListener('touchstart', (e) => { e.preventDefault(); start(e); });
    board.addEventListener('touchmove', (e) => { e.preventDefault(); move(e); });
    board.addEventListener('touchend', (e) => { e.preventDefault(); end(e); });

    function clearBoard() {
      ctx.clearRect(0, 0, board.width, board.height);
      predEl.textContent = '-';
      statusEl.textContent = '';
    }

    clearBtn.addEventListener('click', clearBoard);

    function get28x28Grayscale() {
      // Downscale from 280x280 (10x) to 28x28 and to [0,1]
      const down = document.createElement('canvas');
      down.width = 28; down.height = 28;
      const dctx = down.getContext('2d');
      // White background for proper alpha handling
      dctx.fillStyle = '#ffffff';
      dctx.fillRect(0, 0, 28, 28);
      dctx.drawImage(board, 0, 0, 28, 28);
      const img = dctx.getImageData(0, 0, 28, 28);
      const data = img.data; // RGBA
      const arr = new Array(28 * 28);
      for (let i = 0; i < 28 * 28; i++) {
        const r = data[4 * i], g = data[4 * i + 1], b = data[4 * i + 2];
        // luminance
        let v = 0.299 * r + 0.587 * g + 0.114 * b; // 0..255
        // Invert if you prefer black background with white digit
        v = 255 - v;
        arr[i] = v / 255.0; // scale to [0,1]
      }
      return arr;
    }

    async function predict() {
      try {
        statusEl.textContent = 'Predicting...';
        const image = get28x28Grayscale();
        const res = await fetch('/predict', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image })
        });
        const json = await res.json();
        if (res.ok && json && typeof json.prediction !== 'undefined') {
          predEl.textContent = json.prediction;
          statusEl.textContent = 'Done';
        } else {
          predEl.textContent = '-';
          statusEl.textContent = 'Error: ' + (json && json.error ? json.error : 'Unknown');
        }
      } catch (e) {
        predEl.textContent = '-';
        statusEl.textContent = 'Error: ' + e.message;
      }
    }

    predictBtn.addEventListener('click', predict);

    // Initialize white background
    clearBoard();
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, board.width, board.height);
  </script>
</body>
</html>
